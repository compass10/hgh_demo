<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>예약 관리 - 관리자</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="admin-page">
        <aside class="admin-sidebar">
            <h1 class="admin-sidebar__logo">관리자</h1>
            <nav class="admin-sidebar__nav">
                <a href="index.html" class="admin-sidebar__item active">예약 관리</a>
                <a href="#" class="admin-sidebar__item" onclick="alert('교육 관리 페이지 (데모)')">교육 관리</a>
                <a href="#" class="admin-sidebar__item" onclick="alert('알림톡 발송 페이지 (데모)')">알림톡 발송</a>
            </nav>
            <a href="../index.html" class="admin-sidebar__logout" onclick="logout()">로그아웃</a>
        </aside>

        <main class="admin-main">
            <div class="admin-header">
                <h2>예약자 목록</h2>
                <button class="btn-excel" onclick="alert('엑셀 다운로드 기능 (데모)')">엑셀 다운로드</button>
            </div>

            <div class="filter-bar">
                <select id="statusFilter" onchange="filterReservations()">
                    <option value="">전체 상태</option>
                    <option value="신청완료">신청완료</option>
                    <option value="확정">확정</option>
                    <option value="출석완료">출석완료</option>
                    <option value="취소">취소</option>
                    <option value="노쇼">노쇼</option>
                </select>
                <select id="educationFilter" onchange="filterReservations()">
                    <option value="">전체 교육</option>
                    <!-- 동적으로 채워짐 -->
                </select>
                <span class="filter-result" id="filterResult">총 0건</span>
            </div>

            <div class="admin-table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>신청일</th>
                            <th>신청자</th>
                            <th>회사명</th>
                            <th>등급</th>
                            <th>교육명</th>
                            <th>교육일시</th>
                            <th>상태</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="reservationTable">
                        <!-- 동적으로 채워짐 -->
                    </tbody>
                </table>
            </div>

            <div class="pagination">
                <button disabled>이전</button>
                <span class="pagination__current">1</span>
                <button disabled>다음</button>
            </div>
        </main>

        <!-- 상세 모달 -->
        <div class="modal-overlay" id="detailModal" style="display: none;">
            <div class="modal modal--lg">
                <div class="modal__header">
                    <h3>예약 상세</h3>
                    <button class="modal__close" onclick="closeModal('detailModal')">×</button>
                </div>
                <div class="modal__body" id="modalBody">
                    <!-- 동적으로 채워짐 -->
                </div>
                <div class="modal__footer">
                    <button class="btn btn-secondary" onclick="closeModal('detailModal')">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/data.js"></script>
    <script src="../js/app.js"></script>
    <script>
        const user = checkAuth(true);
        if (!user) throw new Error('Not authenticated');

        let reservations = getAllReservations();
        let filteredReservations = [...reservations];
        let currentReservation = null;

        // 교육 필터 초기화
        function initEducationFilter() {
            const educationList = [...new Set(reservations.map(r => r.educationName))];
            const select = document.getElementById('educationFilter');
            educationList.forEach(edu => {
                const option = document.createElement('option');
                option.value = edu;
                option.textContent = edu;
                select.appendChild(option);
            });
        }

        // 예약 목록 렌더링
        function renderReservations() {
            const tableBody = document.getElementById('reservationTable');
            document.getElementById('filterResult').textContent = `총 ${filteredReservations.length}건`;

            tableBody.innerHTML = filteredReservations.map(r => `
        <tr>
          <td>${r.appliedAt}</td>
          <td class="td-name">${escapeHtml(r.applicantName)}</td>
          <td>${escapeHtml(r.company)}</td>
          <td>
            <span class="grade-badge grade--${r.grade === '정회원' ? 'regular' : 'education'}">
              ${r.grade}
            </span>
          </td>
          <td class="td-education">${escapeHtml(r.educationName)}</td>
          <td class="td-date">
            ${r.date}<br>
            <span class="time">${r.time}</span>
          </td>
          <td>
            <span class="status-badge ${getStatusClass(r.status)}">
              ${r.status}
            </span>
          </td>
          <td class="td-actions">
            <button class="btn-sm btn-primary" onclick="showDetail(${r.id})">상세</button>
          </td>
        </tr>
      `).join('');
        }

        // 필터링
        function filterReservations() {
            const statusFilter = document.getElementById('statusFilter').value;
            const educationFilter = document.getElementById('educationFilter').value;

            filteredReservations = reservations.filter(r => {
                if (statusFilter && r.status !== statusFilter) return false;
                if (educationFilter && r.educationName !== educationFilter) return false;
                return true;
            });

            renderReservations();
        }

        // 상세 보기
        function showDetail(id) {
            currentReservation = reservations.find(r => r.id === id);
            if (!currentReservation) return;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
        <div class="detail-grid">
          <div class="detail-section">
            <h4>신청자 정보</h4>
            <p><strong>이름:</strong> ${escapeHtml(currentReservation.applicantName)}</p>
            <p><strong>회사:</strong> ${escapeHtml(currentReservation.company)}</p>
            <p><strong>연락처:</strong> ${escapeHtml(currentReservation.phone)}</p>
            <p><strong>이메일:</strong> ${escapeHtml(currentReservation.email)}</p>
            <p><strong>회원등급:</strong> ${currentReservation.grade}</p>
            <p><strong>멤버십 만료:</strong> ${currentReservation.membershipExpiry}</p>
          </div>
          <div class="detail-section">
            <h4>교육 정보</h4>
            <p><strong>교육명:</strong> ${escapeHtml(currentReservation.educationName)}</p>
            <p><strong>유형:</strong> ${currentReservation.educationType}</p>
            <p><strong>일시:</strong> ${currentReservation.date} ${currentReservation.time}</p>
            <p><strong>신청일:</strong> ${currentReservation.appliedAt}</p>
          </div>
        </div>

        <div class="status-control">
          <h4>상태 변경</h4>
          <div class="status-buttons">
            ${['신청완료', '확정', '출석완료', '취소', '노쇼'].map(status => `
              <button class="btn-status ${currentReservation.status === status ? 'active' : ''} ${getStatusClass(status)}"
                      onclick="changeStatus(${currentReservation.id}, '${status}')">
                ${status}
              </button>
            `).join('')}
          </div>
        </div>
      `;

            openModal('detailModal');
        }

        // 상태 변경
        function changeStatus(id, newStatus) {
            // 데이터 업데이트
            const index = reservations.findIndex(r => r.id === id);
            if (index !== -1) {
                reservations[index].status = newStatus;
                localStorage.setItem('demoAdminReservations', JSON.stringify(reservations));
            }

            // UI 업데이트
            filterReservations();
            if (currentReservation && currentReservation.id === id) {
                currentReservation.status = newStatus;
                showDetail(id);
            }
        }

        // 모달 외부 클릭 시 닫기
        document.getElementById('detailModal').addEventListener('click', function (e) {
            if (e.target === this) closeModal('detailModal');
        });

        // 초기화
        initEducationFilter();
        renderReservations();
    </script>
</body>

</html>